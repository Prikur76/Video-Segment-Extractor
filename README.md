# Video Segment Extractor

Проект **Video Segment Extractor** предназначен для автоматического извлечения и сохранения сегментов видео на основе аннотаций. Он позволяет обрабатывать видеофайлы, разделять их на фрагменты по меткам и сохранять эти фрагменты в структурированные папки. Проект также поддерживает независимый функционал сжатия видео.

---

## Основные возможности

- **Загрузка конфигураций**: Поддержка конфигурационных файлов в формате YAML.
- **Загрузка аннотаций**: Чтение аннотаций из JSON-файлов.
- **Извлечение сегментов**: Разделение видео на фрагменты по меткам.
- **Сохранение сегментов**: Автоматическое сохранение фрагментов в структурированные папки.
- **Многопоточная обработка**: Поддержка параллельного выполнения для ускорения обработки.
- **Классификация меток**: Автоматическая классификация меток на категории: `kata`, `combinations`, `elements`.
- **Сжатие видео**: Независимый функционал для сжатия видеофайлов.

---

## Структура проекта

```
video_segment_extractor/
│
├── configs/                    # Папка для конфигурационных файлов
│   └── config.yaml             # Пример конфигурационного файла
│
├── data/                       # Папка для входных и выходных данных
│   ├── input/                  # Входные данные (видео, аннотации)
│   └── output/                 # Выходные данные (обработанные сегменты)
│
├── src/                        # Основной код проекта
│   ├── loaders/                # Модули для загрузки данных
│   │   ├── config_loader.py    # Загрузка конфигураций
│   │   └── annotation_loader.py # Загрузка аннотаций
│   ├── processors/             # Модули для обработки данных
│   │   └── video_processor.py  # Обработка видео и сегментов
│   ├── services/               # Основные сервисы
│   │   └── segment_extractor.py # Логика извлечения сегментов
│   ├── utils/                  # Вспомогательные утилиты
│   │   ├── logger.py           # Логгер
│   │   └── decorators.py       # Декораторы (например, @timer)
│   ├── compress_videos.py      # Скрипт для сжатия видео
│   └── main.py                 # Точка входа в приложение
│
├── tests/                      # Папка для тестов
│   ├── unit/                   # Юнит-тесты
│   └── integration/            # Интеграционные тесты
│
├── requirements.txt            # Зависимости проекта
├── README.md                   # Документация проекта
└── .gitignore                  # Игнорируемые файлы для Git
```

---

## Установка

1. **Клонируйте репозиторий**:
   ```bash
   git clone https://github.com/Prikur76/video-segment-extractor.git
   cd video-segment-extractor
   ```

2. **Установите зависимости**:
   ```bash
   pip install -r requirements.txt
   ```

3. **Настройте конфигурацию**:
   - Создайте файл `configs/config.yaml` на основе примера ниже.

---

## Конфигурационный файл

Пример файла `config.yaml`:

```yaml
- video_dataset: "20250125"
  video_paths:
    - data/input/video_1.mp4
    - data/input/video_2.mp4
  json_path: data/input/video_1.json  
  frame_offsets: [0, 9497]  # Отступы должны быть расположены в соответствии с порядком видеофайлов
  output_dir: "data/output/20250125"
  codec: libx264
  fps: 30.00
  execution_mode: parallel  # Возможные значения: "parallel" или "sequential"
```

---

## Запуск проекта

### 1. **Извлечение сегментов видео**

1. Запустите основной скрипт:
   ```bash
   python src/main.py
   ```

2. Результаты:
   - Обработанные сегменты будут сохранены в папке `data/output/` в структурированном виде:
     ```
     data/output/
     ├── 20250125/
     │   ├── kata/
     │   │   ├── Heian-Nidan/
     │   │   │   ├── 1/
     │   │   │   │   └── cam1_1.mp4
     │   ├── combinations/
     │   │   ├── 01.KRK/
     │   │   │   ├── 1/
     │   │   │   │   └── cam1_1.mp4
     │   └── elements/
     │       ├── L-Kokutsu-Dachi/
     │       │   ├── 1/
     │       │   │   └── cam1_1.mp4
     ```

---

### 2. **Сжатие видео**

Для сжатия видео независимо от процесса сегментирования используйте скрипт `compress_videos.py`.

#### Запуск

1. Перейдите в папку проекта:
   ```bash
   cd video_segment_extractor
   ```

2. Запустите скрипт сжатия:
   ```bash
   python src/compress_videos.py data/input data/output --fps 24 --codec libx265
   ```

#### Аргументы

- `input_dir`: Папка с исходными видеофайлами.
- `output_dir`: Папка для сохранения сжатых видео.
- `--fps`: Целевой FPS для сжатия (по умолчанию: 30.0).
- `--codec`: Кодек для сжатия (по умолчанию: `libx264`).
- `--duration`: Длительность сжатия в секундах (опционально).

#### Пример

```bash
python src/compress_videos.py data/input data/output --fps 24 --codec libx265 --duration 10
```

Этот скрипт сожмет все видеофайлы в папке `data/input` и сохранит их в папку `data/output` с указанными параметрами.

---

## Логирование

- Все действия логируются в консоль.
- Пример вывода:
  ```
  2023-10-01 12:00:00 - INFO - Segment data/output/20250125/kata/Heian-Nidan/1/cam1_1.mp4 saved successfully.
  2023-10-01 12:05:00 - INFO - Обработка завершена для конфигурации: 20250125
  ```

---

## Зависимости

- **moviepy**: Для работы с видео.
- **PyYAML**: Для загрузки конфигурационных файлов.
- **multiprocessing**: Для многопоточного выполнения.

Установите зависимости с помощью:
```bash
pip install -r requirements.txt
```

---

## Тестирование

- **Юнит-тесты**: Запустите тесты из папки `tests/unit/`.
- **Интеграционные тесты**: Запустите тесты из папки `tests/integration/`.

---

## Лицензия

Этот проект распространяется под лицензией MIT. Подробности см. в файле [LICENSE](LICENSE).

---

## Автор

- **Vladimir Shisterov**
- **GitHub**: [https://github.com/Prikur76](https://github.com/Prikur76)

---

## Благодарности

- Спасибо сообществу разработчиков за вдохновение и поддержку.
- Особая благодарность авторам библиотек `moviepy` и `PyYAML`.

---
